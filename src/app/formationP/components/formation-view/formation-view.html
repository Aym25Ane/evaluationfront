@if(formationComputed(); as f) {
  <div class="lms-container">

    <!-- 1. HERO HEADER: L'accroche visuelle -->
    <header class="course-hero">
      <div class="hero-backdrop" [style.backgroundImage]="'url(' + (f.image || 'assets/placeholder-course.jpg') + ')'">
        <div class="overlay"></div>
      </div>

      <div class="hero-content">
        <div class="badge-row">
          <span class="badge-level">{{ f.niveau || 'Tous niveaux' }}</span>
          <span class="badge-update"><i class="bi bi-clock-history"></i> Mis à jour le {{ f.derniereMiseAJour | date:'mediumDate' }}</span>
        </div>

        <h1 class="course-title">{{ f.titre }}</h1>

        @if(f.description) {
          <p class="course-description">{{ f.description }}</p>
        }
      </div>
    </header>

    <!-- 2. MAIN CONTENT: Le contenu du cours -->
    <main class="course-curriculum">

      <!-- Liste des Modules (Cours) -->
      @for(cours of f.cours ?? []; track cours.id) {
        <section class="module-card">
          <div class="module-header">
            <h2 class="module-title">
              <span class="module-prefix">Module {{$index + 1}}</span>
              {{ cours.titre }}
            </h2>
            @if(cours.resume) {
              <p class="module-summary">{{ cours.resume }}</p>
            }
          </div>

          <!-- Liste des Chapitres (Accordéon) -->
          <div class="chapter-list">
            @for(chapitre of cours.chapitres ?? []; track chapitre.id) {
              <div class="chapter-item" [class.is-open]="isChapterOpen(chapitre)">

                <!-- Header Cliquable -->
                <button class="chapter-toggle" (click)="toggleChapter(chapitre)">
                  <div class="toggle-info">
                    <i class="bi" [class.bi-caret-right-fill]="!isChapterOpen(chapitre)" [class.bi-caret-down-fill]="isChapterOpen(chapitre)"></i>
                    <span class="chapter-title">{{ chapitre.titre }}</span>
                  </div>
                  <span class="lesson-count">{{ chapitre.sections?.length || 0 }} leçon(s)</span>
                </button>

                <!-- Contenu Déroulant -->
                @if(isChapterOpen(chapitre)) {
                  <div class="chapter-body">
                    @for(section of chapitre.sections ?? []; track section.id) {
                      <div class="lesson-row">

                        <!-- Icône selon le type -->
                        <div class="lesson-icon">
                          @if(section.typeContenu === 'VIDEO') { <i class="bi bi-play-circle-fill play-icon"></i> }
                          @else if(section.typeContenu === 'TEXTE') { <i class="bi bi-file-text-fill text-icon"></i> }
                          @else { <i class="bi bi-image-fill img-icon"></i> }
                        </div>

                        <div class="lesson-content">
                          <h4 class="lesson-type-label">{{ section.typeContenu }}</h4>

                          <!-- Affichage conditionnel -->
                          @if(section.typeContenu === 'TEXTE') {
                            <div class="lesson-text">{{ section.contenu }}</div>
                          }

                          @if(section.typeContenu === 'VIDEO') {
                            <div class="video-wrapper">
                              <video controls controlsList="nodownload">
                                <source [src]="section.contenu" type="video/mp4">
                                Votre navigateur ne supporte pas la lecture vidéo.
                              </video>
                            </div>
                          }

                          @if(section.typeContenu === 'IMAGE') {
                            <div class="image-wrapper">
                              <img [src]="'assets/placeholder.png'" alt="Contenu visuel">
                            </div>
                          }
                        </div>
                      </div>
                    } @empty {
                      <div class="empty-chapter">Ce chapitre est vide pour le moment.</div>
                    }
                  </div>
                }
              </div>
            } @empty {
              <div class="empty-module">Aucun chapitre dans ce module.</div>
            }
          </div>
        </section>
      } @empty {
        <div class="empty-course">
          <i class="bi bi-inbox"></i>
          <p>Le contenu de cette formation est en cours de création.</p>
        </div>
      }
    </main>
  </div>
}
